<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Racing Puzzle Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        </div>

    <script type="module">
        // Import modules
        import Puzzle from './scripts/puzzle.js';
        import RacerGame from './scripts/RacerGame.js';
        import TouchControls from './scripts/TouchControls.js';
        import UIManager from './scripts/UIManager.js'; // Assuming UIManager handles general menus

        // --- Asset Loading ---
        const assets = {};
        const assetPaths = {
            car: 'assets/car.png',
            enemy: 'assets/enemy.png',
            road: 'assets/road.png',
            start: 'assets/start.png',
            finish: 'assets/finish.png',
            flame: 'assets/flame.png',
            coin: 'assets/coin.png',
            nitro: 'assets/nitro.png',
            health: 'assets/health.png',
            joystick: 'assets/joystick.png',
        };

        const loadAssets = async () => {
            const promises = [];
            for (const key in assetPaths) {
                const img = new Image();
                img.src = assetPaths[key];
                assets[key] = img;
                promises.push(new Promise(res => img.onload = res));
            }
            // Wait for all images to load
            await Promise.all(promises);
        };
        
        // --- Game Flow ---
        const gameContainer = document.getElementById('game-container');
        let gameCanvas;
        let uiManager;

        const initCanvas = () => {
            if (gameCanvas) gameCanvas.remove();
            
            gameCanvas = document.createElement('canvas');
            gameCanvas.id = 'game-canvas';
            gameCanvas.width = 960;
            gameCanvas.height = 720; // Increase height for better view
            gameContainer.appendChild(gameCanvas);
        };

        const startRacingGame = () => {
            // Re-initialize canvas for clean start
            initCanvas(); 
            
            // Initialize RacerGame
            const game = new RacerGame({
                canvas: gameCanvas,
                assets
            });

            // Initialize Controls and link to game
            const controls = new TouchControls(gameCanvas);
            game.setControls(controls);
            
            // Re-init UI Manager if needed, or update its reference to the running game
            if (uiManager) uiManager.destroy(); // Clear old UI
            uiManager = new UIManager(gameContainer);
            uiManager.initRaceUI(game); // Assuming UIManager has a method to display the race HUD

            game.start();
        };

        const startPuzzle = () => {
            initCanvas();
            
            const puzzle = new Puzzle({
                canvas: gameCanvas,
                rows: 7,
                cols: 7,
                tileSize: 64,
                timeLimitSec: 45,
                progressTarget: 6
            }, () => {
                // Puzzle complete â†’ start race
                // We manually destroy/remove the puzzle canvas/listeners if the class doesn't do it.
                // For simplicity, we just proceed to startRacingGame.
                startRacingGame();
            });
            // The Puzzle class needs an entry method, e.g., puzzle.start()
            puzzle.start();
        };


        const startGame = async () => {
            console.log("Loading assets...");
            await loadAssets();
            console.log("Assets loaded. Starting puzzle...");
            
            // Start the flow with the puzzle
            startPuzzle();
        };

        startGame();
    </script>
</body>
</html>
