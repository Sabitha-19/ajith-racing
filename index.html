<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Racing Puzzle Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        </div>

    <script type="module">
        import Puzzle from './scripts/puzzle.js';
        import RacerGame from './scripts/RacerGame.js';
        import TouchControls from './scripts/TouchControls.js';
        import UIManager from './scripts/UIManager.js';

        const gameContainer = document.getElementById('game-container');
        const gameCanvasId = 'game-canvas';
        const canvasWidth = 960;
        const canvasHeight = 720; 
        
        let gameCanvas = null;
        let uiManager = null;
        let currentPuzzle = null;
        let racerGame = null;
        
        const assets = {};
        
        // --- FINAL CORRECTED ASSET PATHS ---
        const assetPaths = {
            // IMAGES (assets/ folder)
            car: 'assets/car.png', 
            enemy: 'assets/enemy.png',
            road: 'assets/road.png',
            coin: 'assets/coin.png',
            
            // NOTE: Using .jpg extensions for these two files, as per your uploads
            health: 'assets/health.png.jpg', 
            nitro_powerup: 'assets/nitro.png.jpg', 

            // Puzzle assets - PNGs
            candy_red: 'assets/candy_red.png',
            candy_yellow: 'assets/candy_yellow.png',
            candy_green: 'assets/candy_green.png',
            candy_purple: 'assets/candy_purple.png',
            candy_blue: 'assets/candy_blue.png',
            
            // AUDIO (sound/ folder)
            audio_nitro: 'sound/nitro.mp3',
            audio_crash: 'sound/crash.mp3',
            audio_drift: 'sound/drift.mp3',
            audio_engine: 'sound/engine.mp3',
            audio_brake: 'sound/brake.mp3',
        };
        // --- END OF ASSET PATHS ---

        // --- Asset Loading (Handles PNG/JPG and MP3) ---
        const loadAssets = async () => {
            const promises = [];
            for (const key in assetPaths) {
                const path = assetPaths[key];
                let loadPromise;

                // Handle Images (.png or .jpg)
                if (path.endsWith('.png') || path.endsWith('.jpg')) {
                    const img = new Image();
                    img.src = path;
                    assets[key] = img;
                    loadPromise = new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = () => reject(new Error(`Failed to load IMAGE: ${path}`));
                    });
                } 
                // Handle Audio (.mp3)
                else if (path.endsWith('.mp3') || path.endsWith('.wav')) {
                    const audio = new Audio();
                    audio.src = path;
                    assets[key] = audio;
                    loadPromise = new Promise((resolve, reject) => {
                        audio.addEventListener('canplaythrough', resolve, { once: true });
                        audio.addEventListener('error', () => reject(new Error(`Failed to load AUDIO: ${path}`)), { once: true });
                        audio.load();
                        setTimeout(resolve, 500); 
                    });
                } else {
                    continue; 
                }
                
                promises.push(loadPromise);
            }
            
            console.log("Starting asset loading...");
            try {
                await Promise.all(promises);
                console.log("All assets loaded successfully.");
            } catch (error) {
                console.error("Asset loading failed:", error.message);
                gameContainer.innerHTML = `<h1 style="color: red; text-align: center;">ERROR: Missing Asset. Check console for 404 errors.</h1>`;
                throw error;
            }
        };
        
        // --- Game Flow Handlers ---
        const initCanvas = () => {
            const existingCanvas = document.getElementById(gameCanvasId);
            if (existingCanvas) existingCanvas.remove();
            
            gameCanvas = document.createElement('canvas');
            gameCanvas.id = gameCanvasId;
            gameCanvas.width = canvasWidth;
            gameCanvas.height = canvasHeight; 
            
            gameContainer.appendChild(gameCanvas); 
        };
        
        const startPuzzle = () => {
            initCanvas();
            if (currentPuzzle) currentPuzzle.destroy();
            
            currentPuzzle = new Puzzle({
                canvas: gameCanvas,
                assets: assets,
                rows: 7,
                cols: 7,
                tileSize: 64,
                timeLimitSec: 45,
                progressTarget: 20
            }, () => {
                if (currentPuzzle) currentPuzzle.destroy();
                uiManager.showCountryMenu();
            });
        };

        const startRacingGame = (countryName) => {
            initCanvas();
            uiManager.hideCountryMenu();
            uiManager.showHUD();
            
            racerGame = new RacerGame({
                canvas: gameCanvas,
                assets,
                country: countryName
            });

            const controls = new TouchControls(gameCanvas);
            racerGame.setControls(controls); 
            
            racerGame.onTimeUpdate = (time) => {
                uiManager.updateGameTime(time);
            };

            racerGame.start();
            
            // Start the engine audio
            if (assets.audio_engine) {
                assets.audio_engine.loop = true;
                assets.audio_engine.volume = 0.5;
                assets.audio_engine.play().catch(e => console.log("Engine audio playback blocked.", e));
            }
        };


        // --- Initialization ---

        const initGame = async () => {
            try {
                await loadAssets();
                initCanvas();

                uiManager = new UIManager(gameContainer);
                uiManager.hookCallbacks({
                    onPlay: startPuzzle, 
                    onSelectCountry: startRacingGame
                });
                
            } catch (error) {
                // If loading fails, the error message is already displayed by loadAssets
            }
        };

        initGame();
    </script>
</body>
</html>
