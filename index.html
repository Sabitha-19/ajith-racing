<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Racing Puzzle Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        </div>

    <script type="module">
        // Import modules from the 'scripts' folder
        import Puzzle from './scripts/puzzle.js';
        import RacerGame from './scripts/RacerGame.js';
        import TouchControls from './scripts/TouchControls.js';
        import UIManager from './scripts/UIManager.js';

        // --- Asset Loading ---
        const assets = {};
        const assetPaths = {
            car: 'assets/car.png',
            enemy: 'assets/enemy.png',
            road: 'assets/road.png',
            start: 'assets/start.png',
            finish: 'assets/finish.png',
            flame: 'assets/flame.png',
            coin: 'assets/coin.png',
            nitro: 'assets/nitro.png',
            health: 'assets/health.png',
            joystick: 'assets/joystick.png',
        };

        const loadAssets = async () => {
            const promises = [];
            for (const key in assetPaths) {
                const img = new Image();
                img.src = assetPaths[key];
                assets[key] = img;
                // Create a promise that resolves when the image is loaded
                promises.push(new Promise(res => img.onload = res));
            }
            // Wait for all images to load before starting the game
            await Promise.all(promises);
        };
        
        // --- Game Flow Variables ---
        const gameContainer = document.getElementById('game-container');
        let gameCanvas;
        let uiManager;

        const initCanvas = () => {
            // Remove previous canvas if it exists
            if (gameCanvas) gameCanvas.remove();
            
            // Create and append the main canvas
            gameCanvas = document.createElement('canvas');
            gameCanvas.id = 'game-canvas';
            gameCanvas.width = 960;
            gameCanvas.height = 720; 
            gameContainer.appendChild(gameCanvas);
        };

        const startRacingGame = () => {
            console.log("Starting Racing Game...");
            initCanvas(); 
            
            // Initialize RacerGame
            const game = new RacerGame({
                canvas: gameCanvas,
                assets
            });

            // Initialize Controls and link to game
            const controls = new TouchControls(gameCanvas);
            // RacerGame polls controls via a method (simplified from original plan)
            game.setControls(controls); 
            
            // Setup UI (HUD, buttons, etc.)
            if (uiManager) uiManager.destroy();
            uiManager = new UIManager(gameContainer);
            uiManager.initRaceUI(game);

            game.start();
        };

        const startPuzzle = () => {
            console.log("Starting Puzzle...");
            initCanvas();
            
            // Initialize Puzzle
            const puzzle = new Puzzle({
                canvas: gameCanvas,
                rows: 7,
                cols: 7,
                tileSize: 64,
                timeLimitSec: 45,
                progressTarget: 6
            }, () => {
                // Puzzle complete callback â†’ start race
                puzzle.destroy(); // Cleanup puzzle resources
                startRacingGame();
            });
            
            // Start the puzzle loop/interaction
            puzzle.start();
        };


        const startGame = async () => {
            console.log("Loading assets...");
            await loadAssets();
            console.log("Assets loaded. Starting initial flow (Puzzle)...");
            
            // The game flow starts with the puzzle minigame
            startPuzzle();
        };

        // Initialize the game when the script runs
        startGame();
    </script>
</body>
</html>
