<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Racing Puzzle Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        </div>

    <script type="module">
        // Import modules
        import Puzzle from './scripts/puzzle.js';
        import RacerGame from './scripts/RacerGame.js';
        import TouchControls from './scripts/TouchControls.js';
        import UIManager from './scripts/UIManager.js';

        // --- Global State & Configuration ---
        const gameContainer = document.getElementById('game-container');
        const gameCanvasId = 'game-canvas';
        const canvasWidth = 960;
        const canvasHeight = 720; 
        
        let gameCanvas = null;
        let uiManager = null;
        let currentPuzzle = null;
        
        // Define all required assets for both Puzzle and Race
        const assets = {};
        const assetPaths = {
            car: 'assets/car.png',
            enemy: 'assets/enemy.png',
            road: 'assets/road.png',
            start: 'assets/start.png',
            finish: 'assets/finish.png',
            flame: 'assets/flame.png',
            coin: 'assets/coin.png',
            nitro: 'assets/nitro.png',
            health: 'assets/health.png',
            joystick: 'assets/joystick.png',
            // Add all puzzle assets here (must match the paths in puzzle.js)
            candy_red: 'assets/candy_red.png',
            candy_yellow: 'assets/candy_yellow.png',
            candy_green: 'assets/candy_green.png',
            candy_purple: 'assets/candy_purple.png',
            candy_blue: 'assets/candy_blue.png',
        };

        // --- Asset Loading ---
        const loadAssets = async () => {
            const promises = [];
            for (const key in assetPaths) {
                const img = new Image();
                img.src = assetPaths[key];
                assets[key] = img;
                promises.push(new Promise(res => img.onload = res));
            }
            await Promise.all(promises);
            console.log("All assets loaded successfully.");
        };
        
        // --- Canvas Management ---
        const initCanvas = () => {
            // Remove previous canvas if it exists (e.g., when transitioning from Puzzle)
            const existingCanvas = document.getElementById(gameCanvasId);
            if (existingCanvas) existingCanvas.remove();
            
            gameCanvas = document.createElement('canvas');
            gameCanvas.id = gameCanvasId;
            gameCanvas.width = canvasWidth;
            gameCanvas.height = canvasHeight; 
            
            // The UIManager handles placing the canvas inside its wrapper element 
            // when the Puzzle or RacerGame is initialized.
            // For now, we just attach it to the container temporarily until the game starts.
            gameContainer.appendChild(gameCanvas); 
        };
        
        // --- Game Flow Handlers ---

        const startPuzzle = () => {
            console.log("Starting Puzzle Mini-Game...");
            // The Puzzle constructor will re-parent the canvas into its own wrapper
            // and apply its size. We pass the canvas reference.
            
            if (currentPuzzle) currentPuzzle.destroy();
            
            currentPuzzle = new Puzzle({
                canvas: gameCanvas,
                rows: 7,
                cols: 7,
                tileSize: 64,
                timeLimitSec: 45,
                progressTarget: 20 // Increased target for a slightly longer game
            }, () => {
                // Puzzle complete callback
                if (currentPuzzle) currentPuzzle.destroy();
                uiManager.showCountryMenu();
            });
        };

        const startRacingGame = (countryName) => {
            console.log(`Starting Racing Game in ${countryName}...`);
            
            // We need to re-initialize the canvas here if the puzzle wrapper was used
            // but since the puzzle destructor removes the wrapper, we might need a clean start.
            initCanvas(); // Re-initialize the canvas if needed (if Puzzle removed it)

            uiManager.hideCountryMenu();
            uiManager.showHUD();
            
            // Initialize RacerGame
            const game = new RacerGame({
                canvas: gameCanvas,
                assets,
                country: countryName
            });

            // Initialize Controls and link to game
            const controls = new TouchControls(gameCanvas);
            game.setControls(controls); 
            
            // The UIManager needs a way to update the time during the race
            game.onTimeUpdate = (time) => {
                uiManager.updateGameTime(time);
            };

            game.start();
        };


        // --- Initialization ---

        const initGame = async () => {
            await loadAssets();
            initCanvas();

            // Initialize UIManager and hook up flow
            uiManager = new UIManager(gameContainer);
            uiManager.hookCallbacks({
                onPlay: startPuzzle, 
                onSelectCountry: startRacingGame
            });
            
            // The UIManager is set to automatically show the Main Menu on creation.
        };

        // Start the process
        initGame();
    </script>
</body>
</html>
